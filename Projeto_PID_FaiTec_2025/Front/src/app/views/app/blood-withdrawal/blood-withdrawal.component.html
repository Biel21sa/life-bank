<div class="withdrawal-container">
  <!-- Hero Section -->
  <div class="hero-section">
    <div class="hero-background">
      <div class="floating-element element-1"></div>
      <div class="floating-element element-2"></div>
      <div class="floating-element element-3"></div>
    </div>
    
    <div class="hero-content">
      <div class="withdrawal-icon">
        <mat-icon>remove_circle_outline</mat-icon>
      </div>
      <h1>Retirada de Sangue</h1>
      <p class="hero-subtitle">Selecione as bolsas e registre o motivo da retirada do estoque</p>
    </div>
  </div>

  <!-- Selection Summary -->
  <div class="selection-summary" *ngIf="selection.selected.length > 0">
    <div class="summary-container">
      <div class="summary-icon">
        <mat-icon>check_circle</mat-icon>
      </div>
      <div class="summary-content">
        <div class="summary-count">{{selection.selected.length}}</div>
        <div class="summary-label">bolsa(s) selecionada(s)</div>
        <div class="summary-volume">{{getTotalVolume()}}ml total</div>
      </div>
      <div class="summary-actions">
        <button mat-icon-button class="clear-selection" (click)="clearSelection()" matTooltip="Limpar seleção">
          <mat-icon>clear</mat-icon>
        </button>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="content-section">
    <div class="content-container">
      
      <!-- Filters Section -->
      <div class="filters-section">
        <div class="filters-card">
          <div class="filters-header">
            <div class="header-icon">
              <mat-icon>filter_list</mat-icon>
            </div>
            <div class="header-content">
              <h3>Filtros de Busca</h3>
              <p>Refine a lista de bolsas disponíveis</p>
            </div>
          </div>
          
          <div class="filters-content">
            <div class="filter-group">
              <mat-form-field appearance="outline" class="filter-field">
                <mat-label>Tipo Sanguíneo</mat-label>
                <mat-select [ngModel]="selectedBloodType" 
                           (selectionChange)="onBloodTypeChange($event.value)"
                           [ngModelOptions]="{standalone: true}">
                  <mat-option value="Todos">
                    <div class="option-content">
                      <mat-icon>bloodtype</mat-icon>
                      <span>Todos os tipos</span>
                    </div>
                  </mat-option>
                  <mat-option *ngFor="let type of bloodTypes" [value]="type">
                    <div class="option-content">
                      <mat-icon>bloodtype</mat-icon>
                      <span>{{type}}</span>
                    </div>
                  </mat-option>
                </mat-select>
                <mat-hint>Filtrar por tipo sanguíneo específico</mat-hint>
              </mat-form-field>
              
              <div class="filter-stats">
                <div class="stat-item">
                  <mat-icon>inventory</mat-icon>
                  <span>{{filteredBloodList.length}} bolsas disponíveis</span>
                </div>
                <div class="stat-item" *ngIf="getExpiredCount() > 0">
                  <mat-icon>warning</mat-icon>
                  <span>{{getExpiredCount()}} próximas ao vencimento</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Blood List Section -->
      <div class="blood-list-section">
        <div class="list-card">
          <div class="list-header">
            <div class="header-left">
              <div class="header-icon">
                <mat-icon>list</mat-icon>
              </div>
              <div class="header-content">
                <h3>Bolsas Disponíveis</h3>
                <p>Selecione as bolsas para retirada</p>
              </div>
            </div>
            <div class="header-actions">
              <button mat-stroked-button class="select-all-btn" 
                      (click)="masterToggle()"
                      [disabled]="filteredBloodList.length === 0">
                <mat-icon>{{isAllSelected() ? 'deselect' : 'select_all'}}</mat-icon>
                <span>{{isAllSelected() ? 'Desmarcar' : 'Selecionar'}} Todos</span>
              </button>
            </div>
          </div>
          
          <div class="list-content">
            <!-- Table Container -->
            <div class="table-container" *ngIf="filteredBloodList.length > 0">
              <table mat-table [dataSource]="filteredBloodList" class="blood-table">
                
                <!-- Selection Column -->
                <ng-container matColumnDef="select">
                  <th mat-header-cell *matHeaderCellDef class="select-column">
                    <mat-checkbox (change)="$event ? masterToggle() : null"
                      [checked]="selection.hasValue() && isAllSelected()"
                      [indeterminate]="selection.hasValue() && !isAllSelected()"
                      [aria-label]="'Selecione todas as linhas'">
                    </mat-checkbox>
                  </th>
                  <td mat-cell *matCellDef="let row" class="select-column">
                    <mat-checkbox (click)="$event.stopPropagation()" 
                      (change)="$event ? selection.toggle(row) : null"
                      [checked]="selection.isSelected(row)" 
                      [aria-label]="'Selecione a linha'">
                    </mat-checkbox>
                  </td>
                </ng-container>

                <!-- Blood Type Column -->
                <ng-container matColumnDef="bloodType">
                  <th mat-header-cell *matHeaderCellDef>
                    <div class="column-header">
                      <mat-icon>bloodtype</mat-icon>
                      <span>Tipo Sanguíneo</span>
                    </div>
                  </th>
                  <td mat-cell *matCellDef="let blood">
                    <div class="blood-type-cell">
                      <div class="blood-type-badge">{{blood.bloodType}}</div>
                    </div>
                  </td>
                </ng-container>

                <!-- Quantity Column -->
                <ng-container matColumnDef="quantity">
                  <th mat-header-cell *matHeaderCellDef>
                    <div class="column-header">
                      <mat-icon>local_drink</mat-icon>
                      <span>Volume</span>
                    </div>
                  </th>
                  <td mat-cell *matCellDef="let blood">
                    <div class="quantity-cell">
                      <span class="quantity-value">{{blood.quantity}}</span>
                      <span class="quantity-unit">ml</span>
                    </div>
                  </td>
                </ng-container>

                <!-- Expiration Date Column -->
                <ng-container matColumnDef="expirationDate">
                  <th mat-header-cell *matHeaderCellDef>
                    <div class="column-header">
                      <mat-icon>schedule</mat-icon>
                      <span>Validade</span>
                    </div>
                  </th>
                  <td mat-cell *matCellDef="let blood">
                    <div class="expiration-cell" [ngClass]="getExpirationStatus(blood.expirationDate)">
                      <mat-icon>{{getExpirationIcon(blood.expirationDate)}}</mat-icon>
                      <span>{{blood.expirationDate | date:'dd/MM/yyyy'}}</span>
                    </div>
                  </td>
                </ng-container>

                <!-- Status Column -->
                <ng-container matColumnDef="status">
                  <th mat-header-cell *matHeaderCellDef>
                    <div class="column-header">
                      <mat-icon>info</mat-icon>
                      <span>Status</span>
                    </div>
                  </th>
                  <td mat-cell *matCellDef="let blood">
                    <div class="status-cell">
                      <div class="status-badge" [ngClass]="getExpirationStatus(blood.expirationDate)">
                        {{getStatusText(blood.expirationDate)}}
                      </div>
                    </div>
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns;" 
                    [class.selected-row]="selection.isSelected(row)"
                    (click)="toggleRowSelection(row)"></tr>
              </table>
            </div>
            
            <!-- Empty State -->
            <div class="empty-state" *ngIf="filteredBloodList.length === 0">
              <div class="empty-icon">
                <mat-icon>inventory_2</mat-icon>
              </div>
              <h4>Nenhuma bolsa encontrada</h4>
              <p>Não há bolsas de sangue disponíveis com os filtros selecionados.</p>
              <button mat-stroked-button (click)="clearFilters()">
                <mat-icon>refresh</mat-icon>
                <span>Limpar Filtros</span>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Reason Section -->
      <div class="reason-section">
        <div class="reason-card">
          <div class="reason-header">
            <div class="header-icon">
              <mat-icon>assignment</mat-icon>
            </div>
            <div class="header-content">
              <h3>Motivo da Retirada</h3>
              <p>Selecione o motivo para registrar a saída do estoque</p>
            </div>
          </div>
          
          <div class="reason-content">
            <div class="reason-options">
              <div class="reason-option" 
                   [class.selected]="selectedReason === 'Descarte'"
                   (click)="onReasonChange('Descarte')">
                <div class="option-icon descarte">
                  <mat-icon>delete</mat-icon>
                </div>
                <div class="option-content">
                  <h4>Descarte</h4>
                  <p>Bolsas vencidas ou inadequadas para uso</p>
                </div>
                <div class="option-check">
                  <mat-icon *ngIf="selectedReason === 'Descarte'">check_circle</mat-icon>
                  <mat-icon *ngIf="selectedReason !== 'Descarte'">radio_button_unchecked</mat-icon>
                </div>
              </div>
              
              <div class="reason-option" 
                   [class.selected]="selectedReason === 'Uso'"
                   (click)="onReasonChange('Uso')">
                <div class="option-icon uso">
                  <mat-icon>local_hospital</mat-icon>
                </div>
                <div class="option-content">
                  <h4>Uso Médico</h4>
                  <p>Utilização em procedimentos ou transfusões</p>
                </div>
                <div class="option-check">
                  <mat-icon *ngIf="selectedReason === 'Uso'">check_circle</mat-icon>
                  <mat-icon *ngIf="selectedReason !== 'Uso'">radio_button_unchecked</mat-icon>
                </div>
              </div>
            </div>
            
            <!-- Reason Details -->
            <div class="reason-details" *ngIf="selectedReason">
              <div class="details-header">
                <mat-icon>info</mat-icon>
                <span>Detalhes da Retirada</span>
              </div>
              <div class="details-content">
                <div class="detail-item">
                  <span class="detail-label">Motivo:</span>
                  <span class="detail-value">{{selectedReason}}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Bolsas selecionadas:</span>
                  <span class="detail-value">{{selection.selected.length}}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Volume total:</span>
                  <span class="detail-value">{{getTotalVolume()}}ml</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Actions Section -->
      <div class="actions-section">
        <div class="actions-container">
          <div class="actions-left">
            <button mat-stroked-button class="cancel-button" (click)="goBack()">
              <mat-icon>arrow_back</mat-icon>
              <span>Voltar</span>
            </button>
          </div>
          
          <div class="actions-right">
            <div class="action-summary" *ngIf="canSubmit()">
              <div class="summary-text">
                <span class="summary-count">{{selection.selected.length}}</span>
                <span class="summary-label">bolsa(s) • {{getTotalVolume()}}ml</span>
              </div>
            </div>
            
            <button mat-raised-button color="warn" 
                    class="confirm-button"
                    [disabled]="!canSubmit()"
                    (click)="onSubmit()">
              <mat-icon>check</mat-icon>
              <span>Confirmar Retirada</span>
            </button>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Confirmation Dialog would be handled by the component -->
</div>
